# 試験問題作成・管理システム 仕様書 (V2.1)

## 1. システム概要
本システムは、Excelで作成された試験問題マスターデータを起点に、問題用紙（LaTeX）と解答用紙（ReportLab）を自動生成する統合パイプラインです。版（A版・B版）の同時生成や、データベースによるバージョン管理（ハッシュ値による変更検知）を備えています。


---

## 2. ジョブフローとデータ遷移
システムの各工程と、プログラム間のデータの流れを整理した相関図です。

### フェーズ 1: Excelマスターの編集・整形
* **`excelupdate.py`**
    * **役割**: 編集中のExcelにQID（Q001〜）を付与し、見出し行を挿入。
    * **Input**: `試験問題.xlsm` (Active Sheet) / **Output**: `試験問題.xlsm` (直接更新)

### フェーズ 2: 中間JSONへの変換と整合性検証
* **`maketexjson.py` / `makedocjsonv2.py`**
    * **役割**: 問題本文を構造化JSONへ変換。数式保護や特殊文字置換を実施。
    * **`anstest_ans.py`**
    * **役割**: 解答情報に特化したJSON（`answers_科目名.json`）を生成。
    * **共通依存**: `utils.py`, `versioncontrol.py`, `contract.py`
    * **Input**: `試験問題.xlsm` / **Output**: `work/*.json`

### フェーズ 3: 最終成果物（PDF）の生成
* **問題用紙（LaTeX系）**
    1. **`makelatexv2.py`**: JSONからLaTeX本文（`body.tex`）を書き出し。
    2. **`texmerge_compile.py`**: テンプレート結合とLuaLaTeXによるPDFビルド。
* **解答用紙（ReportLab系）**
    1. **`anstest_ans.py`**: 内部で `ansmake1.py` を呼び出し。
    2. **`ansmake1.py`**: ReportLabを用いて解答用紙PDFを直接生成。

---

## 3. プログラムファイル役割一覧
| 分類           | ファイル名            | 役割詳細                                       |
| :------------- | :-------------------- | :--------------------------------------------- |
| **Excel操作**  | `excelupdate.py`      | Excel上でのID付与、得点集計、見出し挿入。      |
| **JSON変換**   | `maketexjson.py`      | 問題用紙用のJSON変換主幹。                     |
| **JSON変換**   | `anstest_ans.py`      | 解答用紙用のJSON変換およびPDF生成の司令塔。    |
| **PDF生成**    | `makelatexv2.py`      | JSON → LaTeX 変換。                            |
| **PDF生成**    | `texmerge_compile.py` | LaTeX結合とコンパイル（問題用紙出力）。        |
| **PDF生成**    | `ansmake1.py`         | 解答用紙PDFのレイアウト描画。                  |
| **モジュール** | `utils.py`            | ハッシュ計算、余白解析、画像解析等の共通関数。 |
| **モジュール** | `contract.py`         | JSON構造定義とバリデーション。                 |
| **モジュール** | `versioncontrol.py`   | SQLite（`versions.db`）による版管理。          |

---

## 4. コマンドライン実行例
ルートディレクトリ（`project_root`）で実行してください。

### ① Excelの自動採番
```bash
python scripts/excelupdate.py
```



## 5. 解答用JSONおよび解答用紙PDFの同時生成
```bash
python scripts/anstest_ans.py 1020201
```
